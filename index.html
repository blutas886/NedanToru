<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ãƒ¢ãƒè¨˜éŒ²</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  body {
    background: #0d0d1a;
    color: #f0f0f0;
    font-family: 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
    min-height: 100vh;
    max-width: 480px;
    margin: 0 auto;
  }

  .header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid #1e1e3a;
  }
  .back-btn {
    color: #7b7bff; background: transparent; border: none;
    font-size: 20px; cursor: pointer; font-family: inherit; padding: 4px 8px;
  }
  .header-title { font-size: 17px; font-weight: 600; }

  .hero { padding: 60px 20px 40px; text-align: center; }
  .hero-icon { font-size: 64px; margin-bottom: 12px; }
  .hero-title { font-size: 36px; font-weight: 800; margin-bottom: 8px; letter-spacing: -1px; }
  .hero-sub { font-size: 14px; color: #888; }

  .actions { padding: 0 20px; display: flex; flex-direction: column; gap: 12px; }
  .action-label {
    border: 1px solid #2e2e5e; border-radius: 14px; padding: 18px 20px;
    color: #f0f0f0; font-size: 18px; font-weight: 600;
    cursor: pointer; font-family: inherit;
    display: flex; align-items: center; gap: 12px;
    transition: opacity .15s; user-select: none;
  }
  .action-label:active { opacity: 0.7; }
  .action-label input[type="file"] { display: none; }
  .action-icon { font-size: 24px; }

  .history-btn {
    margin: 16px 20px 0;
    background: #111130; border: 1px solid #2e2e5e;
    border-radius: 14px; padding: 16px 20px;
    color: #f0f0f0; font-size: 16px; font-weight: 600;
    cursor: pointer; font-family: inherit;
    display: flex; align-items: center; justify-content: space-between;
    width: calc(100% - 40px);
  }
  .badge { background: #2e2e5e; border-radius: 8px; padding: 4px 10px; font-size: 13px; color: #aaa; }

  /* API KEY */
  .api-setup {
    margin: 16px 20px 0;
    background: #0a0a1e; border: 1px solid #2a2a4e;
    border-radius: 14px; padding: 16px 20px;
  }
  .api-setup-title { font-size: 13px; color: #8888ff; margin-bottom: 8px; font-weight: 600; }
  .api-key-row { display: flex; gap: 8px; }
  .api-key-input {
    flex: 1; background: #0d0d1a; border: 1px solid #2a2a4e;
    border-radius: 8px; padding: 10px 12px;
    color: #f0f0f0; font-size: 14px; font-family: inherit; outline: none;
  }
  .api-key-input:focus { border-color: #7b7bff; }
  .api-save-btn {
    background: #1a1a3a; border: 1px solid #3a3a6a;
    border-radius: 8px; padding: 10px 14px;
    color: #aaaaff; font-size: 13px; font-weight: 600;
    cursor: pointer; font-family: inherit; white-space: nowrap;
  }
  .api-status { font-size: 12px; color: #777; margin-top: 6px; }
  .api-status.ok { color: #44cc88; }

  /* ENTRY */
  .preview-wrap { padding: 16px 20px 0; }
  .preview-wrap img { width: 100%; border-radius: 12px; object-fit: cover; max-height: 220px; }
  .no-image {
    width: 100%; height: 120px; border-radius: 12px;
    background: #1a1a2e; border: 2px dashed #2e2e5e;
    display: flex; align-items: center; justify-content: center;
    color: #555; font-size: 14px;
  }

  .ai-analyze-btn {
    margin-top: 10px; width: 100%;
    background: linear-gradient(135deg, #1a1a3e, #0e0e2a);
    border: 1px solid #4a4aaa; border-radius: 10px; padding: 12px;
    color: #aaaaff; font-size: 15px; font-weight: 600;
    cursor: pointer; font-family: inherit;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    transition: opacity .15s;
  }
  .ai-analyze-btn:active { opacity: 0.7; }
  .ai-analyze-btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .ai-spinner {
    width: 16px; height: 16px; border: 2px solid #aaaaff44;
    border-top-color: #aaaaff; border-radius: 50%;
    animation: spin .7s linear infinite; display: none;
  }
  .ai-spinner.show { display: block; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .section { padding: 16px 20px 0; }
  .field-label { font-size: 13px; color: #888; display: block; margin-bottom: 6px; }

  .name-input {
    width: 100%;
    background: #1a1a2e; border: 1px solid #2e2e5e;
    border-radius: 10px; padding: 12px 14px;
    color: #f0f0f0; font-size: 18px; font-family: inherit; outline: none;
  }
  .name-input:focus { border-color: #7b7bff; }

  .memo-input {
    width: 100%;
    background: #1a1a2e; border: 1px solid #2e2e5e;
    border-radius: 10px; padding: 12px 14px;
    color: #f0f0f0; font-size: 15px; font-family: inherit; outline: none;
    resize: none; min-height: 80px; line-height: 1.5;
  }
  .memo-input:focus { border-color: #7b7bff; }

  .price-display {
    background: #1a1a2e; border-radius: 10px; padding: 14px 20px;
    display: flex; align-items: baseline; gap: 6px; margin-bottom: 12px;
  }
  .yen { font-size: 22px; color: #888; }
  .price-num { font-size: 36px; font-weight: 700; color: #fff; letter-spacing: 1px; }

  .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
  .num-key {
    background: #1a1a2e; border: 1px solid #2e2e5e;
    border-radius: 10px; padding: 16px 0;
    color: #f0f0f0; font-size: 22px; font-weight: 600;
    cursor: pointer; font-family: inherit; transition: background .1s;
  }
  .num-key:active { background: #2e2e5e; }
  .key-clear { background: #2a1a1a; color: #ff7777; border-color: #3e2e2e; }
  .key-back  { background: #1a2a1a; color: #77ffaa; border-color: #2e3e2e; }

  .save-btn {
    margin: 24px 20px 40px;
    background: linear-gradient(135deg, #7b7bff, #5555dd);
    border: none; border-radius: 14px; padding: 16px;
    color: #fff; font-size: 18px; font-weight: 700;
    cursor: pointer; font-family: inherit;
    width: calc(100% - 40px);
  }
  .save-btn:active { opacity: 0.8; }

  /* HISTORY */
  .total-bar {
    margin: 16px 20px;
    background: linear-gradient(135deg, #1a1a3e, #12122e);
    border-radius: 14px; padding: 16px 20px;
    display: flex; justify-content: space-between; align-items: center;
    border: 1px solid #2e2e6e;
  }
  .total-label { font-size: 14px; color: #888; }
  .total-amount { font-size: 28px; font-weight: 800; color: #7b7bff; }

  .list { padding: 0 20px; display: flex; flex-direction: column; gap: 10px; padding-bottom: 40px; }
  .card {
    background: #1a1a2e; border-radius: 12px; padding: 12px;
    display: flex; align-items: flex-start; gap: 12px;
    border: 1px solid #2e2e4e;
  }
  .thumb { width: 56px; height: 56px; border-radius: 8px; object-fit: cover; flex-shrink: 0; }
  .thumb-placeholder {
    width: 56px; height: 56px; border-radius: 8px; flex-shrink: 0;
    background: #2e2e4e; display: flex; align-items: center; justify-content: center; font-size: 24px;
  }
  .card-info { flex: 1; min-width: 0; }
  .card-name { font-size: 16px; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .card-memo { font-size: 12px; color: #888; margin-top: 3px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .card-date { font-size: 12px; color: #666; margin-top: 2px; }
  .card-right { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; flex-shrink: 0; }
  .card-price { font-size: 18px; font-weight: 700; color: #7b7bff; }
  .delete-btn { background: transparent; border: none; color: #555; font-size: 18px; cursor: pointer; padding: 2px 6px; }
  .empty { text-align: center; color: #555; padding: 60px 20px; font-size: 16px; }

  .toast {
    position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
    background: #333; color: #fff;
    border-radius: 10px; padding: 10px 20px;
    font-size: 14px; font-weight: 600; white-space: nowrap;
    z-index: 9999; pointer-events: none;
    opacity: 0; transition: opacity .3s;
  }
  .toast.show { opacity: 1; }

  #camera-view {
    position: fixed; inset: 0; background: #000;
    display: none; flex-direction: column; z-index: 100;
  }
  #camera-view.active { display: flex; }
  #video { flex: 1; object-fit: cover; width: 100%; }
  .camera-bar {
    padding: 20px 40px;
    display: flex; align-items: center; justify-content: space-between;
    background: rgba(0,0,0,0.6);
  }
  .shutter-btn {
    width: 70px; height: 70px; border-radius: 50%;
    border: 3px solid #fff; background: transparent;
    display: flex; align-items: center; justify-content: center; cursor: pointer;
  }
  .shutter-inner { width: 54px; height: 54px; border-radius: 50%; background: #fff; }
  .cam-cancel { color: #fff; background: transparent; border: none; font-size: 28px; cursor: pointer; padding: 8px; }

  .page { display: none; }
  .page.active { display: block; }
</style>
</head>
<body>

<div id="camera-view">
  <video id="video" autoplay playsinline muted></video>
  <div class="camera-bar">
    <button class="cam-cancel" onclick="stopCamera()">âœ•</button>
    <button class="shutter-btn" onclick="capturePhoto()">
      <div class="shutter-inner"></div>
    </button>
    <div style="width:48px"></div>
  </div>
</div>

<!-- ãƒ›ãƒ¼ãƒ  -->
<div id="page-home" class="page active">
  <div class="hero">
    <div class="hero-icon">ğŸ“¦</div>
    <h1 class="hero-title">ãƒ¢ãƒè¨˜éŒ²</h1>
    <p class="hero-sub">æ’®ã£ã¦ãƒ»åå‰ã‚’ã¤ã‘ã¦ãƒ»å€¤æ®µã‚’è¨˜éŒ²</p>
  </div>
  <div class="actions">
    <label class="action-label" style="background:#1a1a2e" onclick="startCamera()">
      <span class="action-icon">ğŸ“·</span>
      <span>ã‚«ãƒ¡ãƒ©ã§æ’®å½±</span>
    </label>
    <label class="action-label" style="background:#16213e">
      <input type="file" accept="image/*" onchange="handleFile(this)">
      <span class="action-icon">ğŸ–¼ï¸</span>
      <span>ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</span>
    </label>
  </div>
  <button class="history-btn" onclick="showPage('history')">
    <span>è¨˜éŒ²ä¸€è¦§ã‚’è¦‹ã‚‹</span>
    <span class="badge" id="home-badge">0ä»¶ / Â¥0</span>
  </button>

  <div class="api-setup">
    <div class="api-setup-title">âœ¨ GPT-4o AIè‡ªå‹•å…¥åŠ› â€” OpenAI APIã‚­ãƒ¼è¨­å®š</div>
    <div class="api-key-row">
      <input id="api-key-input" class="api-key-input" type="password" placeholder="sk-proj-...">
      <button class="api-save-btn" onclick="saveApiKey()">ä¿å­˜</button>
    </div>
    <div class="api-status" id="api-status">æœªè¨­å®šï¼ˆè¨­å®šã™ã‚‹ã¨GPT-4oãŒå•†å“åã‚’è‡ªå‹•å…¥åŠ›ã—ã¾ã™ï¼‰</div>
  </div>
</div>

<!-- å…¥åŠ›ç”»é¢ -->
<div id="page-entry" class="page">
  <div class="header">
    <button class="back-btn" onclick="showPage('home')">â€¹ æˆ»ã‚‹</button>
    <span class="header-title">ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¨˜éŒ²</span>
    <div style="width:60px"></div>
  </div>

  <div class="preview-wrap">
    <img id="preview-img" src="" alt="preview" style="display:none">
    <div id="no-image" class="no-image">ç”»åƒãªã—</div>
    <button id="ai-btn" class="ai-analyze-btn" onclick="analyzeWithAI()" style="display:none">
      <div class="ai-spinner" id="ai-spinner"></div>
      <span id="ai-btn-text">âœ¨ GPT-4oã§å•†å“åã‚’è‡ªå‹•å…¥åŠ›</span>
    </button>
  </div>

  <div class="section">
    <label class="field-label">ã‚¢ã‚¤ãƒ†ãƒ å</label>
    <input id="item-name" class="name-input" type="text" placeholder="ä¾‹ï¼šãƒã‚°ã‚«ãƒƒãƒ—">
  </div>

  <div class="section">
    <label class="field-label">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
    <textarea id="item-memo" class="memo-input" placeholder="è‰²ãƒ»ã‚µã‚¤ã‚ºãƒ»è³¼å…¥å ´æ‰€ãªã©è‡ªç”±ã«å…¥åŠ›"></textarea>
  </div>

  <div class="section">
    <label class="field-label">å€¤æ®µ</label>
    <div class="price-display">
      <span class="yen">Â¥</span>
      <span class="price-num" id="price-display">0</span>
    </div>
    <div class="numpad">
      <button class="num-key" onclick="pressNum('1')">1</button>
      <button class="num-key" onclick="pressNum('2')">2</button>
      <button class="num-key" onclick="pressNum('3')">3</button>
      <button class="num-key" onclick="pressNum('4')">4</button>
      <button class="num-key" onclick="pressNum('5')">5</button>
      <button class="num-key" onclick="pressNum('6')">6</button>
      <button class="num-key" onclick="pressNum('7')">7</button>
      <button class="num-key" onclick="pressNum('8')">8</button>
      <button class="num-key" onclick="pressNum('9')">9</button>
      <button class="num-key key-clear" onclick="pressClear()">C</button>
      <button class="num-key" onclick="pressNum('0')">0</button>
      <button class="num-key key-back" onclick="pressBack()">âŒ«</button>
    </div>
  </div>

  <button class="save-btn" onclick="saveEntry()">ä¿å­˜ã™ã‚‹</button>
</div>

<!-- å±¥æ­´ -->
<div id="page-history" class="page">
  <div class="header">
    <button class="back-btn" onclick="showPage('home')">â€¹ æˆ»ã‚‹</button>
    <span class="header-title">è¨˜éŒ²ä¸€è¦§</span>
    <div style="width:60px"></div>
  </div>
  <div class="total-bar">
    <span class="total-label">åˆè¨ˆ</span>
    <span class="total-amount" id="total-amount">Â¥0</span>
  </div>
  <div class="list" id="record-list"></div>
</div>

<div class="toast" id="toast"></div>
<canvas id="canvas" style="display:none"></canvas>

<script>
let records = JSON.parse(localStorage.getItem('mono-kiroku') || '[]');
let priceStr = '';
let currentImage = null;
let cameraStream = null;
let apiKey = localStorage.getItem('mono-kiroku-openaikey') || '';

updateHomeBadge();
if (apiKey) {
  document.getElementById('api-key-input').value = apiKey;
  document.getElementById('api-status').textContent = 'âœ… APIã‚­ãƒ¼è¨­å®šæ¸ˆã¿ â€” GPT-4oè‡ªå‹•å…¥åŠ›ãŒä½¿ãˆã¾ã™';
  document.getElementById('api-status').classList.add('ok');
}

function saveApiKey() {
  const val = document.getElementById('api-key-input').value.trim();
  if (!val.startsWith('sk-')) {
    showToast('æ­£ã—ã„APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆsk-...ï¼‰');
    return;
  }
  apiKey = val;
  localStorage.setItem('mono-kiroku-openaikey', apiKey);
  const st = document.getElementById('api-status');
  st.textContent = 'âœ… APIã‚­ãƒ¼è¨­å®šæ¸ˆã¿ â€” GPT-4oè‡ªå‹•å…¥åŠ›ãŒä½¿ãˆã¾ã™';
  st.classList.add('ok');
  showToast('APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}

function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  if (name === 'history') renderHistory();
  if (name === 'home') updateHomeBadge();
}

async function startCamera() {
  try {
    const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } } });
    cameraStream = s;
    document.getElementById('video').srcObject = s;
    document.getElementById('camera-view').classList.add('active');
  } catch(e) { showToast('ã‚«ãƒ¡ãƒ©ã®è¨±å¯ãŒå¿…è¦ã§ã™'); }
}

function stopCamera() {
  if (cameraStream) { cameraStream.getTracks().forEach(t => t.stop()); cameraStream = null; }
  document.getElementById('camera-view').classList.remove('active');
}

function capturePhoto() {
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  canvas.width = video.videoWidth; canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  currentImage = canvas.toDataURL('image/jpeg', 0.8);
  stopCamera(); openEntry();
}

function handleFile(input) {
  const file = input.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = e => { currentImage = e.target.result; input.value = ''; openEntry(); };
  reader.readAsDataURL(file);
}

function openEntry() {
  priceStr = '';
  document.getElementById('item-name').value = '';
  document.getElementById('item-memo').value = '';
  updatePriceDisplay();
  const img = document.getElementById('preview-img');
  const noImg = document.getElementById('no-image');
  const aiBtn = document.getElementById('ai-btn');
  if (currentImage) {
    img.src = currentImage; img.style.display = 'block'; noImg.style.display = 'none';
    aiBtn.style.display = apiKey ? 'flex' : 'none';
  } else {
    img.style.display = 'none'; noImg.style.display = 'flex'; aiBtn.style.display = 'none';
  }
  showPage('entry');
}

// â”€â”€ GPT-4o ç”»åƒè§£æ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function analyzeWithAI() {
  if (!apiKey) { showToast('APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„'); return; }
  if (!currentImage) return;

  const btn = document.getElementById('ai-btn');
  const spinner = document.getElementById('ai-spinner');
  const btnText = document.getElementById('ai-btn-text');
  btn.disabled = true; spinner.classList.add('show'); btnText.textContent = 'AIè§£æä¸­...';

  try {
    const res = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        max_tokens: 100,
        messages: [{
          role: 'user',
          content: [
            {
              type: 'image_url',
              image_url: { url: currentImage, detail: 'low' }
            },
            {
              type: 'text',
              text: 'ã“ã®ç”»åƒã«å†™ã£ã¦ã„ã‚‹å•†å“ãƒ»ç‰©ã®åå‰ã‚’æ—¥æœ¬èªã§ç­”ãˆã¦ãã ã•ã„ã€‚ã§ãã‚‹ã ã‘å…·ä½“çš„ãªå•†å“åãƒ»ãƒ–ãƒ©ãƒ³ãƒ‰åãƒ»ç¨®é¡ãŒã‚ã‹ã‚‹ã‚ˆã†ã«ç­”ãˆã¦ãã ã•ã„ã€‚å•†å“åã®ã¿ã‚’20æ–‡å­—ä»¥å†…ã§è¿”ã—ã¦ãã ã•ã„ã€‚èª¬æ˜æ–‡ã¯ä¸è¦ã§ã™ã€‚'
            }
          ]
        }]
      })
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error?.message || `HTTPã‚¨ãƒ©ãƒ¼ ${res.status}`);
    }

    const data = await res.json();
    const name = data.choices?.[0]?.message?.content?.trim();
    if (name) {
      document.getElementById('item-name').value = name;
      showToast('âœ¨ å•†å“åã‚’è‡ªå‹•å…¥åŠ›ã—ã¾ã—ãŸ');
    } else {
      showToast('å•†å“åã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
    }
  } catch(e) {
    console.error(e);
    if (e.message.includes('401')) {
      showToast('APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚ç¢ºèªã—ã¦ãã ã•ã„');
    } else if (e.message.includes('429')) {
      showToast('åˆ©ç”¨åˆ¶é™ä¸­ã§ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ãã ã•ã„');
    } else {
      showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message);
    }
  } finally {
    btn.disabled = false; spinner.classList.remove('show');
    btnText.textContent = 'âœ¨ GPT-4oã§å•†å“åã‚’è‡ªå‹•å…¥åŠ›';
  }
}

function pressNum(n) { if (priceStr.length >= 8) return; priceStr += n; updatePriceDisplay(); }
function pressBack() { priceStr = priceStr.slice(0, -1); updatePriceDisplay(); }
function pressClear() { priceStr = ''; updatePriceDisplay(); }
function updatePriceDisplay() {
  document.getElementById('price-display').textContent = parseInt(priceStr||'0',10).toLocaleString('ja-JP');
}

function saveEntry() {
  const name = document.getElementById('item-name').value.trim();
  if (!name) { showToast('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const memo = document.getElementById('item-memo').value.trim();
  const price = parseInt(priceStr || '0', 10);
  records.unshift({ id: Date.now(), name, memo, price, image: currentImage, date: new Date().toLocaleDateString('ja-JP') });
  persist(); showToast('ä¿å­˜ã—ã¾ã—ãŸï¼'); showPage('history');
}

function renderHistory() {
  const list = document.getElementById('record-list');
  const total = records.reduce((s, r) => s + r.price, 0);
  document.getElementById('total-amount').textContent = 'Â¥' + total.toLocaleString('ja-JP');
  if (records.length === 0) { list.innerHTML = '<div class="empty">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
  list.innerHTML = records.map(r => `
    <div class="card">
      ${r.image ? `<img class="thumb" src="${r.image}" alt="${escHtml(r.name)}">` : `<div class="thumb-placeholder">ğŸ“¦</div>`}
      <div class="card-info">
        <div class="card-name">${escHtml(r.name)}</div>
        ${r.memo ? `<div class="card-memo">ğŸ“ ${escHtml(r.memo)}</div>` : ''}
        <div class="card-date">${r.date}</div>
      </div>
      <div class="card-right">
        <div class="card-price">Â¥${r.price.toLocaleString('ja-JP')}</div>
        <button class="delete-btn" onclick="deleteRecord(${r.id})">âœ•</button>
      </div>
    </div>
  `).join('');
}

function deleteRecord(id) {
  records = records.filter(r => r.id !== id);
  persist(); renderHistory(); showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
}

function persist() {
  localStorage.setItem('mono-kiroku', JSON.stringify(records));
  updateHomeBadge();
}
function updateHomeBadge() {
  const total = records.reduce((s, r) => s + r.price, 0);
  document.getElementById('home-badge').textContent = records.length + 'ä»¶ / Â¥' + total.toLocaleString('ja-JP');
}
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}
function escHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
</script>
</body>
</html>
